<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
    <title>Eventos - Sistema Comercial</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>
<nav th:replace="~{fragments/menu :: menu}"></nav>

<main class="py-4">
    <div class="clientes-container animate__animated animate__fadeIn">
        <h2 class="mb-4">Eventos</h2>

        <div class="clientes-header">
            <h3 class="clientes-title">Lista de Eventos Cadastrados</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventoModal" onclick="limparFormulario()">
                <i class="fas fa-plus me-1"></i> Novo Evento
            </button>
        </div>

        <div class="search-box">
            <input type="text" class="form-control" placeholder="Pesquisar..." id="searchInput">
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                <tr>
                    <th>Título</th>
                    <th>Data</th>
                    <th>Hora Início</th>
                    <th>Hora Fim</th>
                    <th>Valor</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="evento : ${eventos}" class="animate__animated animate__fadeInUp">
                    <td th:text="${evento.titulo}">Título</td>
                    <td th:text="${#temporals.format(evento.dataEvento, 'dd/MM/yyyy')}">01/01/2025</td>
                    <td th:text="${evento.horaInicio}">10:00</td>
                    <td th:text="${evento.horaFim}">12:00</td>
                    <td th:text="${#numbers.formatDecimal(evento.valorTotal, 1, 'COMMA', 2, 'POINT')}">0,00</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                th:onclick="'carregarEventoParaEdicao(' + ${evento.idEvento} + ')'"
                                data-bs-toggle="modal" data-bs-target="#eventoModal">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <form th:action="@{'/eventos/excluir/' + ${evento.idEvento}}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Deseja realmente excluir este evento?')">
                                <i class="fas fa-trash-alt"></i> Excluir
                            </button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${eventos.size() == 0}">
                    <td colspan="6" class="text-center py-4">Nenhum Evento Encontrado</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal fade" id="eventoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animate__animated animate__fadeInDown">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Novo Evento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/eventos/salvar}" method="post">
                <div class="modal-body">
                    <input type="hidden" name="idEvento" id="eventoId">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="titulo" class="form-label">Título *</label>
                                <input type="text" class="form-control" id="titulo" name="titulo" required>
                            </div>

                            <div class="mb-3">
                                <label for="dataEvento" class="form-label">Data *</label>
                                <input type="date" class="form-control" id="dataEvento" name="dataEvento" required>
                            </div>

                            <div class="mb-3">
                                <label for="horaInicio" class="form-label">Hora de Início *</label>
                                <input type="time" class="form-control" id="horaInicio" name="horaInicio" required>
                            </div>

                            <div class="mb-3">
                                <label for="horaFim" class="form-label">Hora de Fim *</label>
                                <input type="time" class="form-control" id="horaFim" name="horaFim" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente" class="form-label">Cliente *</label>
                                <select class="form-select" id="cliente" name="cliente.id" required>
                                    <option value="">Selecione...</option>
                                    <option th:each="c : ${clientes}"
                                            th:value="${c.idCliente}"
                                            th:text="${c.nome}">
                                        Cliente
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="local" class="form-label">Local *</label>
                                <select class="form-select" id="local" name="local.id" required>
                                    <option value="">Selecione...</option>
                                    <option th:each="l : ${locais}"
                                            th:value="${l.idLocal}"
                                            th:text="${l.nome}">
                                        Local
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="valorTotal" class="form-label">Valor Total</label>
                                <input type="number" step="0.01" class="form-control" id="valorTotal" name="valorTotal">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Serviços</label>
                        <div class="row">
                            <div th:each="s : ${servicos}" class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           th:id="'servico_' + ${s.idServico}"
                                           th:name="'servico_' + ${s.idServico}">
                                    <label class="form-check-label d-block"
                                           th:for="'servico_' + ${s.idServico}"
                                           th:text="${s.nome + ' (R$ ' + #numbers.formatDecimal(s.precoUnitario, 1, 'COMMA', 2, 'POINT') + ')'}">
                                    </label>
                                    <div class="input-group mt-1">
                                        <span class="input-group-text">Qtd:</span>
                                        <input type="number" class="form-control"
                                               th:id="'quantidade_' + ${s.idServico}"
                                               th:name="'quantidade_' + ${s.idServico}"
                                               min="1" value="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>


<footer th:replace="~{fragments/footer :: footer}"></footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function carregarEventoParaEdicao(id) {
        fetch('eventos/buscar/' + id)
            .then(res => {
                if (!res.ok) {
                    throw new Error('Erro ao buscar evento');
                }
                return res.json();
            })
            .then(evento => {
                // Preenche campos básicos
                document.getElementById('eventoId').value = evento.idEvento || '';
                document.getElementById('titulo').value = evento.titulo || '';
                document.getElementById('dataEvento').value = evento.dataEvento || '';
                document.getElementById('horaInicio').value = evento.horaInicio || '';
                document.getElementById('horaFim').value = evento.horaFim || '';
                document.getElementById('valorTotal').value = evento.valorTotal || '';
                document.getElementById('observacoes').value = evento.observacoes || '';

                // Preenche cliente e local
                if (evento.cliente) {
                    document.getElementById('cliente').value = evento.cliente.idCliente;
                }
                if (evento.local) {
                    document.getElementById('local').value = evento.local.idLocal;
                }

                // Limpa seleções anteriores
                document.querySelectorAll('[id^="servico_"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                document.querySelectorAll('[id^="quantidade_"]').forEach(input => {
                    input.value = '1';
                });

                // Preenche serviços com quantidades
                if (evento.servicos && evento.servicos.length > 0) {
                    evento.servicos.forEach(servico => {
                        const checkbox = document.getElementById('servico_' + servico.servico.idServico);
                        const quantidadeInput = document.getElementById('quantidade_' + servico.servico.idServico);

                        if (checkbox && quantidadeInput) {
                            checkbox.checked = true;
                            quantidadeInput.value = servico.quantidade || 1;
                        }
                    });
                }

                // Atualiza título e abre o modal
                document.getElementById('modalTitle').textContent = 'Editar Evento';
                const modal = new bootstrap.Modal(document.getElementById('eventoModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Erro:', error);
                alert(error.message);
            });
    }

    function limparFormulario() {
        // Limpa campos básicos
        document.getElementById('modalTitle').textContent = 'Novo Evento';
        document.getElementById('eventoId').value = '';
        document.getElementById('titulo').value = '';
        document.getElementById('dataEvento').value = '';
        document.getElementById('horaInicio').value = '';
        document.getElementById('horaFim').value = '';
        document.getElementById('valorTotal').value = '';
        document.getElementById('observacoes').value = '';
        document.getElementById('cliente').value = '';
        document.getElementById('local').value = '';

        // Limpa serviços
        document.querySelectorAll('[id^="servico_"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.querySelectorAll('[id^="quantidade_"]').forEach(input => {
            input.value = '1';
        });
    }

    document.getElementById('eventoModal').addEventListener('hidden.bs.modal', () => {
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    });

</script>

</body>
</html>
